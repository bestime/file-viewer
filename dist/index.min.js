!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@bestime/utils_browser"),require("@bestime/utils_base")):"function"==typeof define&&define.amd?define(["exports","@bestime/utils_browser","@bestime/utils_base"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).fileLibs={},e.jUtilsBrowser,e.jUtilsBase)}(this,(function(e,t,i){"use strict";function s(e,t,i,s,o,n,r){try{var a=e[n](r),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(s,o)}function o(e){return function(){var t=this,i=arguments;return new Promise((function(o,n){var r=e.apply(t,i);function a(e){s(r,o,n,a,c,"next",e)}function c(e){s(r,o,n,a,c,"throw",e)}a(void 0)}))}}function n(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function r(e,t){return e+t}function a(){return(a=o((function*(e){return new Promise((function(i){t.libraryFile({type:"js",module:"pdfjsLib",attribute:{author:"bestime22",type:"module"},url:e.index,interceptor:function(t){t.GlobalWorkerOptions.workerSrc=e.worker}},i)}))}))).apply(this,arguments)}function c(e,t,i){return l.apply(this,arguments)}function l(){return l=o((function*(e,t,s){var n=yield function(e){return a.apply(this,arguments)}({index:r(e,"pdfjs-5.4.78-dist/build/pdf.js"),worker:r(e,"pdfjs-5.4.78-dist/build/pdf.worker.js")}),c=document.createElement("canvas");c.className="original";var l=document.createElement("div"),h=document.createElement("span"),u=document.createElement("span"),d=document.createElement("b");h.innerText="上一页",u.innerText="下一页",h.className="prev",u.className="next",d.innerText="0/0",l.appendChild(h),l.appendChild(d),l.appendChild(u);var _=0,f=0;l.className="file-viewer-pdf-tool-box";var m=yield n.getDocument({url:t,cMapUrl:r(e,"pdfjs-5.4.78-dist/web/cmaps/"),cMapPacked:!0}).promise,p=0,v=i.debounce((function(e){w("next"===e?(p=i.changeIndex(m.numPages-1,p,1))+1:(p=i.changeIndex(m.numPages-1,p,-1))+1)}),200);function w(e){return g.apply(this,arguments)}function g(){return(g=o((function*(e){d.innerText=e+"/"+m.numPages;var t=yield m.getPage(e),i=t.getViewport({scale:s}),o=c.getContext("2d");_=i.width,f=i.height,c.height=i.height,c.width=i.width,c.style.height=i.height+"px",c.style.width=i.width+"px";var n={canvasContext:o,viewport:i},r=t.render(n);yield r.promise}))).apply(this,arguments)}return u.onclick=function(){v("next")},h.onclick=function(){v("prev")},yield w(1),{width:_,height:f,tool:l,source:c}})),l.apply(this,arguments)}function h(){return(h=o((function*(e){var t=document.createElement("div"),i=document.createElement("img");return i.className="original",new Promise((function(s){i.onload=function(){i.style.width=i.width+"px",i.style.height=i.height+"px",s({source:i,tool:t,width:i.width,height:i.height})},i.onerror=function(){s({width:i.width,height:i.height,source:i,tool:t})},i.src=e}))}))).apply(this,arguments)}function u(){return(u=o((function*(e){return new Promise((function(i){t.libraryFile({type:"css",module:"",attribute:{author:"bestime"},url:e},i)}))}))).apply(this,arguments)}var d="";var _=function(){function e(e){var i=this;this._viewrWrapper=void 0,this._viewrBody=void 0,this._scalevalue=void 0,this._setpvalue=void 0,this._viewrScale=void 0,this._initTimer=void 0,this._config=void 0,this._dataList=[],this._viewTimes=-99999999999999,this._mouse={x:0,y:0,forceX:void 0,forceY:void 0,downX:0,downY:0,isDown:!1},this._rotate={timer:-1,value:0,locking:!1},this._current={type:void 0,index:-1,file:void 0,left:0,top:0,center:[0,0,0,0],initScale:1,minScale:1,maxScale:1},this._scale=1,this._mouseWeelObs=void 0,this._config=Object.assign({theme:"default",ratio:3,mouseWheelPdfScale:!0},e),this._viewrScale=document.createElement("div"),this._onDocMove=this._onDocMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this);var s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");s.className="file-viewer-wrapper",this._config.outline&&(s.className+=" outline"),s.setAttribute("theme",this._config.theme),n.className="file-viewer-tool",r.className="file-viewer-tool-body",o.className="file-viewer-content",this._viewrScale.className="scale-item",o.appendChild(this._viewrScale);var a=document.createElement("span"),c=document.createElement("i"),l=document.createElement("span"),h=document.createElement("span"),u=document.createElement("span"),d=document.createElement("span"),_=document.createElement("span"),f=document.createElement("span"),m=document.createElement("div"),p=document.createElement("div"),v=document.createElement("i");c.className="file-viewer-scale-value",v.className="file-viewer-scale-value",this._scalevalue=v,m.className="icon-group",p.className="icon-group",a.className="prev",l.className="next",d.className="big",_.className="small",f.className="rotate",h.className="adaption",u.className="ratio_1",this._setpvalue=c,a.title="上一个",l.title="下一个",d.title="放大",_.title="缩小",h.title="适配尺寸",f.title="旋转",u.title="1:1显示",n.appendChild(r),p.appendChild(a),p.appendChild(c),p.appendChild(l),r.appendChild(p),r.appendChild(m),m.appendChild(_),m.appendChild(v),m.appendChild(d),m.appendChild(h),m.appendChild(u),r.appendChild(f),s.appendChild(n),s.appendChild(o),l.onclick=function(){var e=i._current.index+1;e===i._dataList.length&&(e=0),i.preview(e)},a.onclick=function(){var e=i._current.index-1;e<0&&(e=i._dataList.length-1),i.preview(e)},d.onclick=function(){i._setMouseToImgCenter(!0,!0),i._stepBig()},_.onclick=function(){i._setMouseToImgCenter(!0,!0),i._stepSmall()},h.onclick=function(){i._mouse.x=0,i._mouse.y=0,i._initCenterScale()},u.onclick=function(){i._mouse.x=0,i._mouse.y=0,i._setScale(1,!0)},this._mouseWeelObs=t.observeMouseWheel(s,(function(e){if(i._mouse.forceX=void 0,i._mouse.forceY=void 0,"pdf"!==i._current.type||i._config.mouseWheelPdfScale)-1===e?i._stepSmall():1===e&&i._stepBig();else{var t,s,o,n,r=null===(t=i._current.file)||void 0===t?void 0:t.tool.querySelector(".next"),a=null===(s=i._current.file)||void 0===s?void 0:s.tool.querySelector(".prev");if(-1===e)null==r||null===(o=r.click)||void 0===o||o.call(r);else null==a||null===(n=a.click)||void 0===n||n.call(a)}}),!0),this._viewrBody=o,this._viewrWrapper=s,s.onmousedown=function(e){i._mouse.downX=e.clientX,i._mouse.downY=e.clientY,i._mouse.isDown=!0,i._viewrBody.classList.add("move"),document.addEventListener("mousemove",i._onDocMove),document.addEventListener("mouseup",i._onMouseUp)},s.onmousemove=function(e){i._mouse.x=e.clientX,i._mouse.y=e.clientY,i._mouse.forceX=void 0,i._mouse.forceY=void 0},f.onclick=function(){if(!i._rotate.locking){i._rotate.locking=!0;var e=i._rotate.value+90,t=i._viewrScale.offsetWidth,s=i._viewrScale.offsetHeight,o=i._viewrScale.getElementsByClassName("original")[0];i._scale,i._viewrScale.style.width=s+"px",i._viewrScale.style.height=t+"px",o.style.transform="rotate("+e+"deg)",i._setScale(i._scale,!1),i._rotate.timer=setTimeout((function(){360===e?(e=0,o.classList.add("no-duration"),o.style.transform="rotate(0deg)",i._rotate.timer=setTimeout((function(){o.classList.remove("no-duration"),i._rotate.locking=!1,i._rotate.value=e}),60)):(i._rotate.locking=!1,i._rotate.value=e)}),400)}}}var s,a,l,_=e.prototype;return _._reset=function(){this._mouse.x=0,this._mouse.y=0,this._mouse.forceX=void 0,this._mouse.forceY=void 0,this._rotate.value=0,clearTimeout(this._rotate.timer),this._rotate.locking=!1,this._current.file&&(this._current.file.tool.remove(),this._current.file.source.remove()),this._viewrScale.classList.add("loading")},_._stepBig=function(){this._setScale(this._scale+.05,!1)},_._stepSmall=function(){this._setScale(this._scale-.05,!1)},_.setData=function(e){if(!e)throw"数据格式不正确";this._dataList=i.isArray(e)?e:[e]},_.preview=function(e){if(e<0||e>=this._dataList.length)throw"当前索引超出了数据级";this._current.index=e,this._show(this._dataList[e]),this._setpvalue.innerHTML=e+1+"/"+this._dataList.length},_._show=function(){var e=o((function*(e){var t,i=this,s=++this._viewTimes;if(this._current.type=e.type,"pdf"===e.type){var[o]=yield Promise.all([c(d,e.url,this._config.ratio)]);t=o}else"image"===e.type&&(t=yield function(e){return h.apply(this,arguments)}(e.url));s===this._viewTimes&&t&&(yield function(e){return u.apply(this,arguments)}(r(d,"index.min.css")),this._reset(),this._current.file=t,this._config.mount&&this._config.mount.appendChild(this._viewrWrapper),this._viewrScale.appendChild(t.source),this._viewrWrapper.appendChild(t.tool),this._viewrScale.style.width=t.width+"px",this._viewrScale.style.height=t.height+"px",clearTimeout(this._initTimer),this._initTimer=setTimeout((function(){i._initCenterScale(),i._viewrScale.classList.remove("loading")}),100))}));return function(t){return e.apply(this,arguments)}}(),_._setMouseToImgCenter=function(e,i){var s=this._viewrWrapper.getElementsByClassName("scale-item")[0],o=t.getRelativePos(this._viewrWrapper),n=t.getRelativePos(s);e&&(n.x+n.width*this._scale>o.x+o.width?this._mouse.forceX=o.x+o.width/2:n.x<o.x?this._mouse.forceX=(n.width*this._scale-(o.x-n.x))/2+o.x:this._mouse.forceX=n.x+n.width*this._scale/2),i&&(n.y+n.height*this._scale>o.y+o.height?this._mouse.forceY=o.y+o.height/2:n.y<o.y?this._mouse.forceY=n.height*this._scale/2-(o.y-n.y)+o.y:this._mouse.forceY=n.y+n.height*this._scale/2)},_._setScale=function(e,s){e=Math.max(this._current.minScale,e),e=Math.min(this._current.maxScale,e);var o=t.getRelativePos(this._viewrScale),n=this._coordinateX-o.x,r=this._coordinateY-o.y,a=n/this._scale*e,c=r/this._scale*e,l=0,h=0,u=!s&&this._canFocusX(e)&&this._canFocusX(this._scale),d=!s&&this._canFocusY(e)&&this._canFocusY(this._scale);l=u?-(a-n)+this._current.left:(this._viewrWrapper.offsetWidth-o.width*e)/2,h=d?-(c-r)+this._current.top:(this._viewrWrapper.offsetHeight-o.height*e)/2,this._viewrScale.style.transform="scale("+e+")",this._scale=e,this._setleftTop(l,h,e,!0,u,d),this._scalevalue.innerText=i.roundFixed(100*e,0)+"%"},_._canFocusX=function(e){var i=t.getRelativePos(this._viewrWrapper),s=t.getRelativePos(this._viewrScale),o=this._viewrScale.offsetWidth*e<=this._viewrWrapper.offsetWidth,n=this._coordinateX>s.x&&this._coordinateX<=s.width*this._scale+s.x,r=Math.ceil(s.x+s.width*this._scale)>=i.x+i.width;return!o&&(n&&r)},_._canFocusY=function(e){var i=t.getRelativePos(this._viewrWrapper),s=t.getRelativePos(this._viewrScale),o=this._viewrScale.offsetHeight*e<=this._viewrWrapper.offsetHeight,n=this._coordinateY>s.y&&this._coordinateY<=s.height*this._scale+s.y,r=Math.ceil(s.y+s.height*this._scale)>=i.y+i.height;return!o&&(n&&r)},_._onDocMove=function(e,t){var i=this._canFocusX(this._scale),s=this._canFocusY(this._scale),o=i||s;if(this._mouse.isDown&&o){var n=i?e.clientX-this._mouse.downX:0,r=s?e.clientY-this._mouse.downY:0;this._setleftTop(this._current.left+n,this._current.top+r,this._scale,!0===t,i,s)}},_._onMouseUp=function(e){this._viewrBody.classList.remove("move"),document.removeEventListener("mousemove",this._onDocMove),document.removeEventListener("mouseup",this._onMouseUp),i.isNull(null==e?void 0:e.clientX)||(this._onDocMove(e,!0),this._mouse.isDown=!1)},_._setleftTop=function(e,i,s,o,n,r){t.getRelativePos(this._viewrWrapper);var a=(this._viewrScale.offsetWidth-this._viewrScale.offsetWidth*s)/2,c=(this._viewrScale.offsetHeight-this._viewrScale.offsetHeight*s)/2,l=0,h=0;if(n){var u=this._viewrScale.offsetWidth*this._scale-this._viewrWrapper.offsetWidth;e>0?(e=0,l=-1):e<=-u&&(l=1,e=-u)}if(r){var d=this._viewrScale.offsetHeight*this._scale-this._viewrWrapper.offsetHeight;i>0?(i=0,h=-1):i<-d&&(h=1,i=-d)}var _=e-a,f=i-c;1===h?f=Math.ceil(f):-1==h&&(f=Math.floor(f)),1===l?_=Math.ceil(_):-1===l&&(_=Math.floor(_)),this._viewrScale.style.left=_+"px",this._viewrScale.style.top=f+"px",o&&(this._current.left=e,this._current.top=i)},_._initCenterScale=function(){var e=t.getRelativePos(this._viewrScale),i=this._viewrWrapper.offsetWidth/this._viewrScale.offsetWidth,s=this._viewrWrapper.offsetHeight/this._viewrScale.offsetHeight,o=Math.min(20/this._viewrScale.offsetWidth,20/this._viewrScale.offsetHeight),n=Math.min(i,s,1),r=(this._viewrWrapper.offsetWidth-this._viewrScale.offsetWidth*n)/2,a=(this._viewrWrapper.offsetHeight-this._viewrScale.offsetHeight*n)/2;this._current.left=0,this._current.top=0,this._scale=n;var c=(e.width-e.width*n)/2,l=(e.height-e.height*n)/2;this._current.center=[r,a,c,l],this._current.initScale=n,this._current.minScale=o,this._current.maxScale=50*n,this._setScale(n,!0)},_.dispose=function(){var e;null==this||null===(e=this._mouseWeelObs)||void 0===e||e.dispose(),this._onMouseUp(),clearTimeout(this._initTimer),clearTimeout(this._rotate.timer)},s=e,(a=[{key:"_coordinateX",get:function(){return i.isNull(this._mouse.forceX)?this._mouse.x:this._mouse.forceX}},{key:"_coordinateY",get:function(){return i.isNull(this._mouse.forceY)?this._mouse.y:this._mouse.forceY}}])&&n(s.prototype,a),l&&n(s,l),Object.defineProperty(s,"prototype",{writable:!1}),e}();e.default=_,e.install=function(e){d=e},Object.defineProperty(e,"__esModule",{value:!0})}));

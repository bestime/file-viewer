import{libraryFile as e,getRelativePos as t,observeMouseWheel as i}from"@bestime/utils_browser";import{debounce as s,changeIndex as o,isArray as n,roundFixed as r,isNull as a}from"@bestime/utils_base";function c(e,t,i,s,o,n,r){try{var a=e[n](r),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(s,o)}function l(e){return function(){var t=this,i=arguments;return new Promise((function(s,o){var n=e.apply(t,i);function r(e){c(n,s,o,r,a,"next",e)}function a(e){c(n,s,o,r,a,"throw",e)}r(void 0)}))}}function h(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function u(e,t){return e+t}function _(){return(_=l((function*(t){return new Promise((function(i){e({type:"js",module:"pdfjsLib",attribute:{author:"bestime",type:"module"},url:t.index,interceptor:function(e){e.GlobalWorkerOptions.workerSrc=t.worker}},i)}))}))).apply(this,arguments)}function d(e,t){return m.apply(this,arguments)}function m(){return m=l((function*(e,t){var i=yield function(e){return _.apply(this,arguments)}({index:u(e,"pdfjs-4.10.38-dist/build/pdf.mjs"),worker:u(e,"pdfjs-4.10.38-dist/build/pdf.worker.mjs")}),n=document.createElement("canvas");n.className="original";var r=document.createElement("div"),a=document.createElement("span"),c=document.createElement("span"),h=document.createElement("b");a.innerText="上一页",c.innerText="下一页",a.className="prev",c.className="next",h.innerText="0/0",r.appendChild(a),r.appendChild(h),r.appendChild(c);var d=0,m=0;r.className="file-viewer-pdf-tool-box";var p=yield i.getDocument({url:t,cMapUrl:u(e,"pdfjs-4.10.38-dist/web/cmaps/"),cMapPacked:!0}).promise,f=0,v=s((function(e){w("next"===e?(f=o(p.numPages-1,f,1))+1:(f=o(p.numPages-1,f,-1))+1)}),200);function w(e){return g.apply(this,arguments)}function g(){return(g=l((function*(e){h.innerText=e+"/"+p.numPages;var t=yield p.getPage(e),i=t.getViewport({scale:3}),s=n.getContext("2d");d=i.width,m=i.height,n.height=i.height,n.width=i.width,n.style.height=i.height+"px",n.style.width=i.width+"px";var o={canvasContext:s,viewport:i},r=t.render(o);yield r.promise}))).apply(this,arguments)}return c.onclick=function(){v("next")},a.onclick=function(){v("prev")},yield w(1),{width:d,height:m,tool:r,source:n}})),m.apply(this,arguments)}function p(){return(p=l((function*(e){var t=document.createElement("div"),i=document.createElement("img");return i.className="original",new Promise((function(s){i.onload=function(){i.style.width=i.width+"px",i.style.height=i.height+"px",s({source:i,tool:t,width:i.width,height:i.height})},i.onerror=function(){s({width:i.width,height:i.height,source:i,tool:t})},i.src=e}))}))).apply(this,arguments)}function f(){return(f=l((function*(t){return new Promise((function(i){e({type:"css",module:"",attribute:{author:"bestime"},url:t},i)}))}))).apply(this,arguments)}var v="";function w(e){v=e}var g=function(){function e(e){var t=this;this._viewrWrapper=void 0,this._viewrBody=void 0,this._scalevalue=void 0,this._setpvalue=void 0,this._viewrScale=void 0,this._initTimer=void 0,this._config=void 0,this._dataList=[],this._viewTimes=-99999999999999,this._mouse={x:0,y:0,forceX:void 0,forceY:void 0,downX:0,downY:0,isDown:!1},this._rotate={timer:-1,value:0,locking:!1},this._current={type:void 0,index:-1,file:void 0,left:0,top:0,center:[0,0,0,0],initScale:1,minScale:1,maxScale:1},this._scale=1,this._mouseWeelObs=void 0,this._config=Object.assign({theme:"default",mouseWheelPdfScale:!0},e),this._viewrScale=document.createElement("div"),this._onDocMove=this._onDocMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this);var s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");s.className="file-viewer-wrapper",this._config.outline&&(s.className+=" outline"),s.setAttribute("theme",this._config.theme),n.className="file-viewer-tool",r.className="file-viewer-tool-body",o.className="file-viewer-content",this._viewrScale.className="scale-item",o.appendChild(this._viewrScale);var a=document.createElement("span"),c=document.createElement("i"),l=document.createElement("span"),h=document.createElement("span"),u=document.createElement("span"),_=document.createElement("span"),d=document.createElement("span"),m=document.createElement("span"),p=document.createElement("div"),f=document.createElement("div"),v=document.createElement("i");c.className="file-viewer-scale-value",v.className="file-viewer-scale-value",this._scalevalue=v,p.className="icon-group",f.className="icon-group",a.className="prev",l.className="next",_.className="big",d.className="small",m.className="rotate",h.className="adaption",u.className="ratio_1",this._setpvalue=c,a.title="上一个",l.title="下一个",_.title="放大",d.title="缩小",h.title="适配尺寸",m.title="旋转",u.title="1:1显示",n.appendChild(r),f.appendChild(a),f.appendChild(c),f.appendChild(l),r.appendChild(f),r.appendChild(p),p.appendChild(d),p.appendChild(v),p.appendChild(_),p.appendChild(h),p.appendChild(u),r.appendChild(m),s.appendChild(n),s.appendChild(o),l.onclick=function(){var e=t._current.index+1;e===t._dataList.length&&(e=0),t.preview(e)},a.onclick=function(){var e=t._current.index-1;e<0&&(e=t._dataList.length-1),t.preview(e)},_.onclick=function(){t._setMouseToImgCenter(!0,!0),t._stepBig()},d.onclick=function(){t._setMouseToImgCenter(!0,!0),t._stepSmall()},h.onclick=function(){t._mouse.x=0,t._mouse.y=0,t._initCenterScale()},u.onclick=function(){t._mouse.x=0,t._mouse.y=0,t._setScale(1,!0)},this._mouseWeelObs=i(s,(function(e){if(t._mouse.forceX=void 0,t._mouse.forceY=void 0,"pdf"!==t._current.type||t._config.mouseWheelPdfScale)-1===e?t._stepSmall():1===e&&t._stepBig();else{var i,s;console.log("pdf翻页");var o,n,r=null===(i=t._current.file)||void 0===i?void 0:i.tool.querySelector(".next"),a=null===(s=t._current.file)||void 0===s?void 0:s.tool.querySelector(".prev");if(-1===e)null==r||null===(o=r.click)||void 0===o||o.call(r);else null==a||null===(n=a.click)||void 0===n||n.call(a)}}),!0),this._viewrBody=o,this._viewrWrapper=s,s.onmousedown=function(e){t._mouse.downX=e.clientX,t._mouse.downY=e.clientY,t._mouse.isDown=!0,t._viewrBody.classList.add("move"),document.addEventListener("mousemove",t._onDocMove),document.addEventListener("mouseup",t._onMouseUp)},s.onmousemove=function(e){t._mouse.x=e.clientX,t._mouse.y=e.clientY,t._mouse.forceX=void 0,t._mouse.forceY=void 0},m.onclick=function(){if(!t._rotate.locking){t._rotate.locking=!0;var e=t._rotate.value+90,i=t._viewrScale.offsetWidth,s=t._viewrScale.offsetHeight,o=t._viewrScale.getElementsByClassName("original")[0];t._scale,t._viewrScale.style.width=s+"px",t._viewrScale.style.height=i+"px",o.style.transform="rotate("+e+"deg)",t._setScale(t._scale,!1),t._rotate.timer=setTimeout((function(){360===e?(e=0,o.classList.add("no-duration"),o.style.transform="rotate(0deg)",t._rotate.timer=setTimeout((function(){o.classList.remove("no-duration"),t._rotate.locking=!1,t._rotate.value=e}),60)):(t._rotate.locking=!1,t._rotate.value=e)}),400)}}}var s,o,c,_=e.prototype;return _._reset=function(){this._mouse.x=0,this._mouse.y=0,this._mouse.forceX=void 0,this._mouse.forceY=void 0,this._rotate.value=0,clearTimeout(this._rotate.timer),this._rotate.locking=!1,this._current.file&&(this._current.file.tool.remove(),this._current.file.source.remove()),this._viewrScale.classList.add("loading")},_._stepBig=function(){this._setScale(this._scale+.05,!1)},_._stepSmall=function(){this._setScale(this._scale-.05,!1)},_.setData=function(e){if(!e)throw"数据格式不正确";this._dataList=n(e)?e:[e]},_.preview=function(e){if(e<0||e>=this._dataList.length)throw"当前索引超出了数据级";this._current.index=e,this._show(this._dataList[e]),this._setpvalue.innerHTML=e+1+"/"+this._dataList.length},_._show=function(){var e=l((function*(e){var t,i=this,s=++this._viewTimes;if(this._current.type=e.type,"pdf"===e.type){var[o]=yield Promise.all([d(v,e.url)]);t=o}else"image"===e.type&&(t=yield function(e){return p.apply(this,arguments)}(e.url));s===this._viewTimes&&t&&(yield function(e){return f.apply(this,arguments)}(u(v,"index.min.css")),this._reset(),this._current.file=t,this._config.mount&&this._config.mount.appendChild(this._viewrWrapper),this._viewrScale.appendChild(t.source),this._viewrWrapper.appendChild(t.tool),this._viewrScale.style.width=t.width+"px",this._viewrScale.style.height=t.height+"px",clearTimeout(this._initTimer),this._initTimer=setTimeout((function(){i._initCenterScale(),i._viewrScale.classList.remove("loading")}),100))}));return function(t){return e.apply(this,arguments)}}(),_._setMouseToImgCenter=function(e,i){var s=this._viewrWrapper.getElementsByClassName("scale-item")[0],o=t(this._viewrWrapper),n=t(s);e&&(n.x+n.width*this._scale>o.x+o.width?this._mouse.forceX=o.x+o.width/2:n.x<o.x?this._mouse.forceX=(n.width*this._scale-(o.x-n.x))/2+o.x:this._mouse.forceX=n.x+n.width*this._scale/2),i&&(n.y+n.height*this._scale>o.y+o.height?this._mouse.forceY=o.y+o.height/2:n.y<o.y?this._mouse.forceY=n.height*this._scale/2-(o.y-n.y)+o.y:this._mouse.forceY=n.y+n.height*this._scale/2)},_._setScale=function(e,i){e=Math.max(this._current.minScale,e),e=Math.min(this._current.maxScale,e);var s=t(this._viewrScale),o=this._coordinateX-s.x,n=this._coordinateY-s.y,a=o/this._scale*e,c=n/this._scale*e,l=0,h=0,u=!i&&this._canFocusX(e)&&this._canFocusX(this._scale),_=!i&&this._canFocusY(e)&&this._canFocusY(this._scale);l=u?-(a-o)+this._current.left:(this._viewrWrapper.offsetWidth-s.width*e)/2,h=_?-(c-n)+this._current.top:(this._viewrWrapper.offsetHeight-s.height*e)/2,this._viewrScale.style.transform="scale("+e+")",this._scale=e,this._setleftTop(l,h,e,!0,u,_),this._scalevalue.innerText=r(100*e,0)+"%"},_._canFocusX=function(e){var i=t(this._viewrWrapper),s=t(this._viewrScale),o=this._viewrScale.offsetWidth*e<=this._viewrWrapper.offsetWidth,n=this._coordinateX>s.x&&this._coordinateX<=s.width*this._scale+s.x,r=Math.ceil(s.x+s.width*this._scale)>=i.x+i.width;return!o&&(n&&r)},_._canFocusY=function(e){var i=t(this._viewrWrapper),s=t(this._viewrScale),o=this._viewrScale.offsetHeight*e<=this._viewrWrapper.offsetHeight,n=this._coordinateY>s.y&&this._coordinateY<=s.height*this._scale+s.y,r=Math.ceil(s.y+s.height*this._scale)>=i.y+i.height;return!o&&(n&&r)},_._onDocMove=function(e,t){var i=this._canFocusX(this._scale),s=this._canFocusY(this._scale),o=i||s;if(this._mouse.isDown&&o){var n=i?e.clientX-this._mouse.downX:0,r=s?e.clientY-this._mouse.downY:0;this._setleftTop(this._current.left+n,this._current.top+r,this._scale,!0===t,i,s)}},_._onMouseUp=function(e){this._viewrBody.classList.remove("move"),document.removeEventListener("mousemove",this._onDocMove),document.removeEventListener("mouseup",this._onMouseUp),a(null==e?void 0:e.clientX)||(this._onDocMove(e,!0),this._mouse.isDown=!1)},_._setleftTop=function(e,i,s,o,n,r){t(this._viewrWrapper);var a=(this._viewrScale.offsetWidth-this._viewrScale.offsetWidth*s)/2,c=(this._viewrScale.offsetHeight-this._viewrScale.offsetHeight*s)/2,l=0,h=0;if(n){var u=this._viewrScale.offsetWidth*this._scale-this._viewrWrapper.offsetWidth;e>0?(e=0,l=-1):e<=-u&&(l=1,e=-u)}if(r){var _=this._viewrScale.offsetHeight*this._scale-this._viewrWrapper.offsetHeight;i>0?(i=0,h=-1):i<-_&&(h=1,i=-_)}var d=e-a,m=i-c;1===h?m=Math.ceil(m):-1==h&&(m=Math.floor(m)),1===l?d=Math.ceil(d):-1===l&&(d=Math.floor(d)),this._viewrScale.style.left=d+"px",this._viewrScale.style.top=m+"px",o&&(this._current.left=e,this._current.top=i)},_._initCenterScale=function(){var e=t(this._viewrScale),i=this._viewrWrapper.offsetWidth/this._viewrScale.offsetWidth,s=this._viewrWrapper.offsetHeight/this._viewrScale.offsetHeight,o=Math.min(20/this._viewrScale.offsetWidth,20/this._viewrScale.offsetHeight),n=Math.min(i,s,1),r=(this._viewrWrapper.offsetWidth-this._viewrScale.offsetWidth*n)/2,a=(this._viewrWrapper.offsetHeight-this._viewrScale.offsetHeight*n)/2;this._current.left=0,this._current.top=0,this._scale=n;var c=(e.width-e.width*n)/2,l=(e.height-e.height*n)/2;this._current.center=[r,a,c,l],this._current.initScale=n,this._current.minScale=o,this._current.maxScale=50*n,this._setScale(n,!0)},_.dispose=function(){var e;null==this||null===(e=this._mouseWeelObs)||void 0===e||e.dispose(),this._onMouseUp(),clearTimeout(this._initTimer),clearTimeout(this._rotate.timer)},s=e,(o=[{key:"_coordinateX",get:function(){return a(this._mouse.forceX)?this._mouse.x:this._mouse.forceX}},{key:"_coordinateY",get:function(){return a(this._mouse.forceY)?this._mouse.y:this._mouse.forceY}}])&&h(s.prototype,o),c&&h(s,c),Object.defineProperty(s,"prototype",{writable:!1}),e}();export{g as default,w as install};

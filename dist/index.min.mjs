import{libraryFile as e,getRelativePos as t,observeMouseWheel as i}from"@bestime/utils_browser";import{changeIndex as s,isNull as o}from"@bestime/utils_base";function n(e,t,i,s,o,n,r){try{var c=e[n](r),a=c.value}catch(e){return void i(e)}c.done?t(a):Promise.resolve(a).then(s,o)}function r(e){return function(){var t=this,i=arguments;return new Promise((function(s,o){var r=e.apply(t,i);function c(e){n(r,s,o,c,a,"next",e)}function a(e){n(r,s,o,c,a,"throw",e)}c(void 0)}))}}function c(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function a(e,t){return e+t}function h(e){return l.apply(this,arguments)}function l(){return(l=r((function*(t){return new Promise((function(i){e({type:"css",module:"",attribute:{author:"bestime"},url:t},i)}))}))).apply(this,arguments)}function u(e){return _.apply(this,arguments)}function _(){return(_=r((function*(t){return new Promise((function(i){e({type:"js",module:"pdfjsLib",attribute:{author:"bestime",type:"module"},url:t.index,interceptor:function(e){e.GlobalWorkerOptions.workerSrc=t.worker}},i)}))}))).apply(this,arguments)}function p(){return(p=r((function*(e){var[t]=yield Promise.all([u({index:a(e,"pdf.min.mjs"),worker:a(e,"pdf.worker.mjs")}),h(a(e,"index.min.css"))]);return t}))).apply(this,arguments)}function d(){return d=r((function*(e,t){var i=yield function(e){return p.apply(this,arguments)}(e),o=document.createElement("canvas");o.className="scale-item";var n=document.createElement("div"),c=document.createElement("span"),a=document.createElement("span"),h=document.createElement("b");c.innerText="上一页",a.innerText="下一页",h.innerText="0/0",n.appendChild(c),n.appendChild(h),n.appendChild(a),n.className="file-viewer-pdf-tool-box";var l=yield i.getDocument(t).promise,u=0;function _(e){return d.apply(this,arguments)}function d(){return(d=r((function*(e){h.innerText=e+"/"+l.numPages;var t=yield l.getPage(e),i=t.getViewport({scale:1}),s=o.getContext("2d");o.height=i.height,o.width=i.width,o.style.width=i.width+"px",o.style.height=i.height+"px";var n={canvasContext:s,viewport:i},r=t.render(n);yield r.promise}))).apply(this,arguments)}return a.onclick=function(){_((u=s(l.numPages-1,u,1))+1)},c.onclick=function(){_((u=s(l.numPages-1,u,-1))+1)},_(1),{tool:n,canvas:o}})),d.apply(this,arguments)}var f="";function m(e){f=e}var v=function(){function e(){var e=this;this._viewrWrapper=void 0,this._viewrBody=void 0,this._viewrScale=void 0,this._mouse={x:0,y:0,forceX:void 0,forceY:void 0,downX:0,downY:0,isDown:!1},this._current={left:0,top:0,center:[0,0,0,0],initScale:1,rotate:0},this._scale=1,this._mouseWeelObs=void 0,this._viewrScale=document.createElement("div"),this._onDocMove=this._onDocMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this);var t=document.createElement("div"),s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div");t.className="file-viewer-wrapper",o.className="file-viewer-tool",n.className="file-viewer-tool-body",s.className="file-viewer-content";var r=document.createElement("span"),c=document.createElement("span"),a=document.createElement("span"),h=document.createElement("span"),l=document.createElement("span"),u=document.createElement("span");r.innerText="上一个",c.innerText="下一个",h.innerText="放大",l.innerText="缩小",a.innerHTML="适配尺寸",u.innerHTML="旋转",o.appendChild(n),n.appendChild(r),n.appendChild(c),n.appendChild(h),n.appendChild(a),n.appendChild(l),n.appendChild(u),t.appendChild(o),t.appendChild(s),h.onclick=function(){e._setMouseToImgCenter(!0,!0),e._stepBig()},l.onclick=function(){e._setMouseToImgCenter(!0,!0),e._stepSmall()},a.onclick=function(){e._mouse.x=0,e._mouse.y=0,e._setScale(e._current.initScale,!0)},this._mouseWeelObs=i(t,(function(t){e._mouse.forceX=void 0,e._mouse.forceY=void 0,-1===t?e._stepSmall():1===t&&e._stepBig()}),!0),this._viewrBody=s,this._viewrWrapper=t,t.onmousedown=function(t){e._mouse.downX=t.clientX,e._mouse.downY=t.clientY,e._mouse.isDown=!0,e._viewrBody.classList.add("move"),document.addEventListener("mousemove",e._onDocMove),document.addEventListener("mouseup",e._onMouseUp)},t.onmousemove=function(t){e._mouse.x=t.clientX,e._mouse.y=t.clientY,e._mouse.forceX=void 0,e._mouse.forceY=void 0},u.onclick=function(){e._current.rotate+=90,360===e._current.rotate&&(e._current.rotate=0),e._viewrWrapper.getElementsByClassName("scale-item")[0].style.transform="scale("+e._scale+") rotate("+e._current.rotate+"deg)",console.log("待开发,用一个容器重新装,里面旋转,外部改变尺寸应该好做一些")}}var s,n,a,h=e.prototype;return h._stepBig=function(){var e=Math.min(this._scale+.1,100);this._setScale(e,!1)},h._stepSmall=function(){var e=Math.max(this._scale-.1,.1);this._setScale(e,!1)},h.show=function(){var e=r((function*(e,i){var s=this,o=yield function(e,t){return d.apply(this,arguments)}(f,i);this._viewrBody.appendChild(o.canvas),this._viewrWrapper.appendChild(o.tool),o.canvas.style.transform="scale(0)",e.appendChild(this._viewrWrapper),setTimeout((function(){s._viewrScale=s._viewrWrapper.getElementsByClassName("scale-item")[0],t(s._viewrWrapper),s._mouse.x=0,s._mouse.y=0,s._mouse.forceX=void 0,s._mouse.forceY=void 0,s._initCenterScale()}),70)}));return function(t,i){return e.apply(this,arguments)}}(),h._setMouseToImgCenter=function(e,i){var s=this._viewrWrapper.getElementsByClassName("scale-item")[0],o=t(this._viewrWrapper),n=t(s),r=this._getRoateSize();e&&(n.x+r.width*this._scale>o.x+o.width?this._mouse.forceX=o.x+o.width/2:n.x<o.x?this._mouse.forceX=(r.width*this._scale-(o.x-n.x))/2+o.x:this._mouse.forceX=n.x+r.width*this._scale/2),i&&(n.y+r.height*this._scale>o.y+o.height?this._mouse.forceY=o.y+o.height/2:n.y<o.y?this._mouse.forceY=r.height*this._scale/2-(o.y-n.y)+o.y:this._mouse.forceY=n.y+r.height*this._scale/2)},h._setScale=function(e,i){var s=t(this._viewrScale),o=this._coordinateX-s.x,n=this._coordinateY-s.y,r=this._getRoateSize();console.log("scaleSize",r);var c=o/this._scale*e,a=n/this._scale*e,h=0,l=0,u=!i&&this._canFocusX(e)&&this._canFocusX(this._scale),_=!i&&this._canFocusY(e)&&this._canFocusY(this._scale);h=u?-(c-o)+this._current.left:(this._viewrWrapper.offsetWidth-r.width*e)/2,l=_?-(a-n)+this._current.top:(this._viewrWrapper.offsetHeight-r.height*e)/2,this._viewrScale.style.transform="scale("+e+") rotate("+this._current.rotate+"deg)",this._scale=e,this._setleftTop(h,l,e,!0,u,_)},h._canFocusX=function(e){var i=t(this._viewrWrapper),s=t(this._viewrScale),o=this._getRoateSize(),n=this._viewrScale.offsetWidth*e<=this._viewrWrapper.offsetWidth,r=this._coordinateX>s.x&&this._coordinateX<=o.width*this._scale+s.x,c=s.x+o.width*this._scale>i.x+i.width;return!n&&(r&&c)},h._canFocusY=function(e){var i=t(this._viewrWrapper),s=this._getRoateSize(),o=t(this._viewrScale),n=this._viewrScale.offsetHeight*e<=this._viewrWrapper.offsetHeight,r=this._coordinateY>o.y&&this._coordinateY<=s.height*this._scale+o.y,c=o.y+s.height*this._scale>i.y+i.height;return!n&&(r&&c)},h._onDocMove=function(e,t){if(this._mouse.isDown&&this._canFocusX(this._scale)&&this._canFocusY(this._scale)){var i=e.clientX-this._mouse.downX,s=e.clientY-this._mouse.downY;this._setleftTop(this._current.left+i,this._current.top+s,this._scale,!0===t,!0,!0)}},h._onMouseUp=function(e){this._viewrBody.classList.remove("move"),document.removeEventListener("mousemove",this._onDocMove),document.removeEventListener("mouseup",this._onMouseUp),o(null==e?void 0:e.clientX)||(this._onDocMove(e,!0),this._mouse.isDown=!1)},h._setleftTop=function(e,i,s,o,n,r){t(this._viewrWrapper);var c=(this._viewrScale.offsetWidth-this._viewrScale.offsetWidth*s)/2,a=(this._viewrScale.offsetHeight-this._viewrScale.offsetHeight*s)/2;if(n){var h=this._viewrScale.offsetWidth*this._scale-this._viewrWrapper.offsetWidth;e>0?e=0:e<=-h&&(e=1-h)}if(r){var l=this._viewrScale.offsetHeight*this._scale-this._viewrWrapper.offsetHeight;i>0?i=0:i<-l&&(i=1-l)}this._viewrScale.style.left=e-c+"px",this._viewrScale.style.top=i-a+"px",o&&(console.log("充值",e,i),this._current.left=e,this._current.top=i)},h._getRoateSize=function(){var e=t(this._viewrScale),i=e.width,s=e.height;return 90!==this._current.rotate&&180!==this._current.rotate||(i=e.height,s=e.width),{width:i,height:s}},h._initCenterScale=function(){var e=t(this._viewrScale),i=this._viewrWrapper.offsetWidth/this._viewrScale.offsetWidth,s=this._viewrWrapper.offsetHeight/this._viewrScale.offsetHeight,o=Math.min(i,s,1),n=(this._viewrWrapper.offsetWidth-this._viewrScale.offsetWidth*o)/2,r=(this._viewrWrapper.offsetHeight-this._viewrScale.offsetHeight*o)/2;this._current.left=0,this._current.top=0,this._scale=o;var c=(e.width-e.width*o)/2,a=(e.height-e.height*o)/2;this._current.center=[n,r,c,a],this._current.initScale=o,this._setScale(o,!0)},h.dispose=function(){var e;null==this||null===(e=this._mouseWeelObs)||void 0===e||e.dispose(),this._onMouseUp()},s=e,(n=[{key:"_coordinateX",get:function(){return o(this._mouse.forceX)?this._mouse.x:this._mouse.forceX}},{key:"_coordinateY",get:function(){return o(this._mouse.forceY)?this._mouse.y:this._mouse.forceY}}])&&c(s.prototype,n),a&&c(s,a),Object.defineProperty(s,"prototype",{writable:!1}),e}();export{v as default,m as install};

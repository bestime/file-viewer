import{libraryFile as e,getRelativePos as t,observeMouseWheel as i}from"@bestime/utils_browser";import{changeIndex as s,isArray as o,roundFixed as n,isNull as r}from"@bestime/utils_base";function a(e,t,i,s,o,n,r){try{var a=e[n](r),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(s,o)}function c(e){return function(){var t=this,i=arguments;return new Promise((function(s,o){var n=e.apply(t,i);function r(e){a(n,s,o,r,c,"next",e)}function c(e){a(n,s,o,r,c,"throw",e)}r(void 0)}))}}function h(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function l(e,t){return e+t}function u(){return(u=c((function*(t){return new Promise((function(i){e({type:"js",module:"pdfjsLib",attribute:{author:"bestime",type:"module"},url:t.index,interceptor:function(e){e.GlobalWorkerOptions.workerSrc=t.worker}},i)}))}))).apply(this,arguments)}function _(e,t){return d.apply(this,arguments)}function d(){return d=c((function*(e,t){var i=yield function(e){return u.apply(this,arguments)}({index:l(e,"pdf.min.mjs"),worker:l(e,"pdf.worker.mjs")}),o=document.createElement("canvas");o.className="original";var n=document.createElement("div"),r=document.createElement("span"),a=document.createElement("span"),h=document.createElement("b");r.innerText="上一页",a.innerText="下一页",r.className="prev",a.className="next",h.innerText="0/0",n.appendChild(r),n.appendChild(h),n.appendChild(a);var _=0,d=0;n.className="file-viewer-pdf-tool-box";var m=yield i.getDocument(t).promise,f=0;function p(e){return v.apply(this,arguments)}function v(){return(v=c((function*(e){h.innerText=e+"/"+m.numPages;var t=yield m.getPage(e),i=t.getViewport({scale:3}),s=o.getContext("2d");_=i.width,d=i.height,o.height=i.height,o.width=i.width,o.style.height=i.height+"px",o.style.width=i.width+"px";var n={canvasContext:s,viewport:i},r=t.render(n);yield r.promise}))).apply(this,arguments)}return a.onclick=function(){p((f=s(m.numPages-1,f,1))+1)},r.onclick=function(){p((f=s(m.numPages-1,f,-1))+1)},yield p(1),{width:_,height:d,tool:n,source:o}})),d.apply(this,arguments)}function m(){return(m=c((function*(e){var t=document.createElement("div"),i=document.createElement("img");return i.className="original",new Promise((function(s){i.onload=function(){i.style.width=i.width+"px",i.style.height=i.height+"px",s({source:i,tool:t,width:i.width,height:i.height})},i.onerror=function(){s({width:i.width,height:i.height,source:i,tool:t})},i.src=e}))}))).apply(this,arguments)}function f(){return(f=c((function*(t){return new Promise((function(i){e({type:"css",module:"",attribute:{author:"bestime"},url:t},i)}))}))).apply(this,arguments)}var p="";function v(e){p=e}var w=function(){function e(e){var t=this;this._viewrWrapper=void 0,this._viewrBody=void 0,this._scalevalue=void 0,this._viewrScale=void 0,this._initTimer=void 0,this._config=void 0,this._dataList=[],this._viewTimes=-99999999999999,this._mouse={x:0,y:0,forceX:void 0,forceY:void 0,downX:0,downY:0,isDown:!1},this._rotate={timer:-1,value:0,locking:!1},this._current={index:-1,file:void 0,left:0,top:0,center:[0,0,0,0],initScale:1,minScale:1,maxScale:1},this._scale=1,this._mouseWeelObs=void 0,this._config=Object.assign({theme:"default"},e),this._viewrScale=document.createElement("div"),this._onDocMove=this._onDocMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this);var s=document.createElement("div"),o=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div");s.className="file-viewer-wrapper",s.setAttribute("theme",this._config.theme),n.className="file-viewer-tool",r.className="file-viewer-tool-body",o.className="file-viewer-content",this._viewrScale.className="scale-item",o.appendChild(this._viewrScale);var a=document.createElement("span"),c=document.createElement("span"),h=document.createElement("span"),l=document.createElement("span"),u=document.createElement("span"),_=document.createElement("span"),d=document.createElement("div"),m=document.createElement("i");m.className="file-viewer-scale-value",this._scalevalue=m,d.className="icon-group",a.className="prev",c.className="next",l.className="big",u.className="small",_.className="rotate",h.className="adaption",a.title="上一个",c.title="下一个",l.title="放大",u.title="缩小",h.title="适配尺寸",_.title="旋转",n.appendChild(r),r.appendChild(a),r.appendChild(c),r.appendChild(d),d.appendChild(u),d.appendChild(m),d.appendChild(l),d.appendChild(h),r.appendChild(_),s.appendChild(n),s.appendChild(o),c.onclick=function(){var e=t._current.index+1;e===t._dataList.length&&(e=0),t.setIndex(e)},a.onclick=function(){var e=t._current.index-1;e<0&&(e=t._dataList.length-1),t.setIndex(e)},l.onclick=function(){t._setMouseToImgCenter(!0,!0),t._stepBig()},u.onclick=function(){t._setMouseToImgCenter(!0,!0),t._stepSmall()},h.onclick=function(){t._mouse.x=0,t._mouse.y=0,t._initCenterScale()},this._mouseWeelObs=i(s,(function(e){t._mouse.forceX=void 0,t._mouse.forceY=void 0,-1===e?t._stepSmall():1===e&&t._stepBig()}),!0),this._viewrBody=o,this._viewrWrapper=s,s.onmousedown=function(e){t._mouse.downX=e.clientX,t._mouse.downY=e.clientY,t._mouse.isDown=!0,t._viewrBody.classList.add("move"),document.addEventListener("mousemove",t._onDocMove),document.addEventListener("mouseup",t._onMouseUp)},s.onmousemove=function(e){t._mouse.x=e.clientX,t._mouse.y=e.clientY,t._mouse.forceX=void 0,t._mouse.forceY=void 0},_.onclick=function(){if(!t._rotate.locking){t._rotate.locking=!0;var e=t._rotate.value+90,i=t._viewrScale.offsetWidth,s=t._viewrScale.offsetHeight,o=t._viewrScale.getElementsByClassName("original")[0];t._scale,t._viewrScale.style.width=s+"px",t._viewrScale.style.height=i+"px",o.style.transform="rotate("+e+"deg)",t._setScale(t._scale,!1),t._rotate.timer=setTimeout((function(){360===e?(e=0,o.classList.add("no-duration"),o.style.transform="rotate(0deg)",t._rotate.timer=setTimeout((function(){o.classList.remove("no-duration"),t._rotate.locking=!1,t._rotate.value=e}),60)):(t._rotate.locking=!1,t._rotate.value=e)}),400)}}}var s,a,u,d=e.prototype;return d._reset=function(){this._mouse.x=0,this._mouse.y=0,this._mouse.forceX=void 0,this._mouse.forceY=void 0,this._rotate.value=0,clearTimeout(this._rotate.timer),this._rotate.locking=!1,this._current.file&&(this._current.file.tool.remove(),this._current.file.source.remove()),this._viewrScale.classList.add("loading")},d._stepBig=function(){this._setScale(this._scale+.05,!1)},d._stepSmall=function(){this._setScale(this._scale-.05,!1)},d.setData=function(e){if(!e)throw"数据格式不正确";this._dataList=o(e)?e:[e],console.log("当前数据",this._dataList)},d.setIndex=function(e){if(e<0||e>=this._dataList.length)throw"当前索引超出了数据级";this._current.index=e,this._show(this._dataList[e]),console.log("显示第："+e+" 张")},d._show=function(){var e=c((function*(e){var t,i=this,s=++this._viewTimes;if("pdf"===e.type){var[o]=yield Promise.all([_(p,e.url)]);t=o}else"image"===e.type&&(t=yield function(e){return m.apply(this,arguments)}(e.url));s===this._viewTimes&&t&&(yield function(e){return f.apply(this,arguments)}(l(p,"index.min.css")),this._reset(),this._current.file=t,this._config.mount&&this._config.mount.appendChild(this._viewrWrapper),this._viewrScale.appendChild(t.source),this._viewrWrapper.appendChild(t.tool),this._viewrScale.style.width=t.width+"px",this._viewrScale.style.height=t.height+"px",clearTimeout(this._initTimer),this._initTimer=setTimeout((function(){i._initCenterScale(),i._viewrScale.classList.remove("loading")}),100))}));return function(t){return e.apply(this,arguments)}}(),d._setMouseToImgCenter=function(e,i){var s=this._viewrWrapper.getElementsByClassName("scale-item")[0],o=t(this._viewrWrapper),n=t(s);e&&(n.x+n.width*this._scale>o.x+o.width?this._mouse.forceX=o.x+o.width/2:n.x<o.x?this._mouse.forceX=(n.width*this._scale-(o.x-n.x))/2+o.x:this._mouse.forceX=n.x+n.width*this._scale/2),i&&(n.y+n.height*this._scale>o.y+o.height?this._mouse.forceY=o.y+o.height/2:n.y<o.y?this._mouse.forceY=n.height*this._scale/2-(o.y-n.y)+o.y:this._mouse.forceY=n.y+n.height*this._scale/2)},d._setScale=function(e,i){e=Math.max(this._current.minScale,e),e=Math.min(this._current.maxScale,e);var s=t(this._viewrScale),o=this._coordinateX-s.x,r=this._coordinateY-s.y,a=o/this._scale*e,c=r/this._scale*e,h=0,l=0,u=!i&&this._canFocusX(e)&&this._canFocusX(this._scale),_=!i&&this._canFocusY(e)&&this._canFocusY(this._scale);h=u?-(a-o)+this._current.left:(this._viewrWrapper.offsetWidth-s.width*e)/2,l=_?-(c-r)+this._current.top:(this._viewrWrapper.offsetHeight-s.height*e)/2,this._viewrScale.style.transform="scale("+e+")",this._scale=e,this._setleftTop(h,l,e,!0,u,_),this._scalevalue.innerText=n(100*e,0)+"%"},d._canFocusX=function(e){var i=t(this._viewrWrapper),s=t(this._viewrScale),o=this._viewrScale.offsetWidth*e<=this._viewrWrapper.offsetWidth,n=this._coordinateX>s.x&&this._coordinateX<=s.width*this._scale+s.x,r=Math.ceil(s.x+s.width*this._scale)>i.x+i.width;return!o&&(n&&r)},d._canFocusY=function(e){var i=t(this._viewrWrapper),s=t(this._viewrScale),o=this._viewrScale.offsetHeight*e<=this._viewrWrapper.offsetHeight,n=this._coordinateY>s.y&&this._coordinateY<=s.height*this._scale+s.y,r=Math.ceil(s.y+s.height*this._scale)>=i.y+i.height;return!o&&(n&&r)},d._onDocMove=function(e,t){var i=this._canFocusX(this._scale),s=this._canFocusY(this._scale),o=i||s;if(this._mouse.isDown&&o){var n=i?e.clientX-this._mouse.downX:0,r=s?e.clientY-this._mouse.downY:0;this._setleftTop(this._current.left+n,this._current.top+r,this._scale,!0===t,i,s)}},d._onMouseUp=function(e){this._viewrBody.classList.remove("move"),document.removeEventListener("mousemove",this._onDocMove),document.removeEventListener("mouseup",this._onMouseUp),r(null==e?void 0:e.clientX)||(this._onDocMove(e,!0),this._mouse.isDown=!1)},d._setleftTop=function(e,i,s,o,n,r){t(this._viewrWrapper);var a=(this._viewrScale.offsetWidth-this._viewrScale.offsetWidth*s)/2,c=(this._viewrScale.offsetHeight-this._viewrScale.offsetHeight*s)/2,h=0,l=0;if(n){var u=this._viewrScale.offsetWidth*this._scale-this._viewrWrapper.offsetWidth;e>0?(e=0,h=-1):e<=-u&&(h=1,e=-u)}if(r){var _=this._viewrScale.offsetHeight*this._scale-this._viewrWrapper.offsetHeight;i>0?(i=0,l=-1):i<-_&&(l=1,i=-_)}var d=e-a,m=i-c;1===l?m=Math.ceil(m):-1==l&&(m=Math.floor(m)),1===h?d=Math.ceil(d):-1===h&&(d=Math.floor(d)),this._viewrScale.style.left=d+"px",this._viewrScale.style.top=m+"px",o&&(this._current.left=e,this._current.top=i)},d._initCenterScale=function(){var e=t(this._viewrScale),i=this._viewrWrapper.offsetWidth/this._viewrScale.offsetWidth,s=this._viewrWrapper.offsetHeight/this._viewrScale.offsetHeight,o=Math.min(20/this._viewrScale.offsetWidth,20/this._viewrScale.offsetHeight),n=Math.min(i,s,1),r=(this._viewrWrapper.offsetWidth-this._viewrScale.offsetWidth*n)/2,a=(this._viewrWrapper.offsetHeight-this._viewrScale.offsetHeight*n)/2;this._current.left=0,this._current.top=0,this._scale=n;var c=(e.width-e.width*n)/2,h=(e.height-e.height*n)/2;this._current.center=[r,a,c,h],this._current.initScale=n,this._current.minScale=o,this._current.maxScale=50*n,this._setScale(n,!0)},d.dispose=function(){var e;null==this||null===(e=this._mouseWeelObs)||void 0===e||e.dispose(),this._onMouseUp(),clearTimeout(this._initTimer),clearTimeout(this._rotate.timer)},s=e,(a=[{key:"_coordinateX",get:function(){return r(this._mouse.forceX)?this._mouse.x:this._mouse.forceX}},{key:"_coordinateY",get:function(){return r(this._mouse.forceY)?this._mouse.y:this._mouse.forceY}}])&&h(s.prototype,a),u&&h(s,u),Object.defineProperty(s,"prototype",{writable:!1}),e}();export{w as default,v as install};
